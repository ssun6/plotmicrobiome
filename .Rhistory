rownames(tab1)[1:10]
runApp('~/git/plotmicrobiome')
runApp()
runApp()
#Metaphlan2 and Kraken2 results
taxa_table9=format_wgs(taxa_file = "./data-raw/mali_kraken2.txt")
#Metaphlan2 and Kraken2 results
taxa_table9=format_wgs(taxa_file = "../data-raw/mali_kraken2.txt")
#Metaphlan2 and Kraken2 results
taxa_table9=format_wgs(taxa_file = "../data-raw/wgs_kraken2.txt")
grep("Fungi",rownames(taxa_table9))
rownames(taxa_table9)[grep("Fungi",rownames(taxa_table9))]
rownames(taxa_table9)[grep("Eukaryota",rownames(taxa_table9))]
taxa_file = "../data-raw/wgs_kraken2.txt"
tab_all=read.table(file=taxa_file,sep=sep,row.names=1,header = T,quote="",check.names=FALSE)
tab_all=as.matrix(tab_all[,order(colnames(tab_all))])
reads_cutoff=1000
tab_all=read.table(file=taxa_file,sep=sep,row.names=1,header = T,quote="",check.names=FALSE)
sep="\t"
tab_all=read.table(file=taxa_file,sep=sep,row.names=1,header = T,quote="",check.names=FALSE)
tab_all=as.matrix(tab_all[,order(colnames(tab_all))])
reads_cutoff
if(!is.null(reads_cutoff)){
tab_all=tab_all[,which(colSums(tab_all)>reads_cutoff)]
}
#tab_all=tab_all[grep("Bacteria",rownames(tab_all)),]
tab_all=tab_all[!rowSums(tab_all)==0,]
if (normalization){
if(rarefy){
tab_all <- rarefy(tab_all, rarefy_num)
}else{
tab_all=t(t(tab_all)/colSums(tab_all))*mean(colSums(tab_all))
}
}else{
tab_all=tab_all
}
normalization=T
rarefy=F
if (normalization){
if(rarefy){
tab_all <- rarefy(tab_all, rarefy_num)
}else{
tab_all=t(t(tab_all)/colSums(tab_all))*mean(colSums(tab_all))
}
}else{
tab_all=tab_all
}
tab_all=tab_all[order(rowSums(tab_all),decreasing = T),]
rownames(tab_all)=taxa_edit(rownames(tab_all))
tab_all=tab_all[which(!grepl("__--__--__",rownames(tab_all))),]
taxa_l=c("d__","p__","c__","o__","f__","g__","s__","t__")
miss_row=vector()
j=1
for (i in 1:nrow(tab_all)){
n1=strsplit(rownames(tab_all)[i],"--")[[1]]
n2=length(n1)
if(!grepl(taxa_l[n2],n1[n2])){
miss_row[j]=i
j=j+1
}
}
miss_row
miss_row[1:10]
rownames(tab_all)[miss_row[1:10]]
colSums(tab_all[miss_row,])
colSums(tab_all[miss_row,])/colSums(tab_all)
sort(colSums(tab_all[miss_row,])/colSums(tab_all))
sort(tab_all[,"CMV009"])
sort(tab_all[,"CMV009"],decreasing = T)[1;10]
sort(tab_all[,"CMV009"],decreasing = T)[1:10]
miss_row[1:4]
i=26
rownames(tab_all)[i]
n1=strsplit(rownames(tab_all)[i],"--")[[1]]
n2=length(n1)
n2
taxa_l[n2]
n1[n2]
n1
rownames(tab_all)[grep("Fungi",rownames(tab_all))]
a=gsub("--k__Fungi--","",rownames(tab_all))
grep("Fungi",a)
a[grep("Fungi",a)]
a=gsub("--k__Fungi","",rownames(tab_all))
a[grep("Fungi",a)]
a[grep("Eukaryota",a)]
rownames(tab_all)[miss_row[1:20]]
rownames(tab_all)=gsub("--k__Fungi","",rownames(tab_all))
rownames(tab_all)[miss_row[1:20]]
a[grep("f__Siphoviridae",a)]
a[grep("o__Caudovirales",a)]
length(miss_row)
dim(tab_all)
a[grep("p__*o__Caudovirales",a)]
a[grep("o__Caudovirales",a)]
b=a[grep("o__Caudovirales",a)]
c=sapply(strsplit(b,"--"),"[[",2)
table(c)
c=sapply(strsplit(b,"--"),"[[",1)
table(c)
rownames(tab_all)[miss_row[1:10]]
i
n1=strsplit(rownames(tab_all)[i],"--")[[1]]
n2=length(n1)
name_new=vector()
for (m in 1:7){
if (grepl(taxa_l[n2],n1[n2])){
name_new[m]=n1[n2]
}else{
name_new[m]=taxa_l[n2]
}
}
name_new
n1
taxa_l%in%n1
taxa_l
n1
taxa_l[1]%in%n1
taxa_l[1]%in%n1[1]
grep(taxa_l[1],n1)
taxa_l[1]
n1
grep("s__",n1)
grep(taxa_l[m],n1)
n1=strsplit(rownames(tab_all)[i],"--")[[1]]
n2=length(n1)
name_new=vector()
i
for (m in 1:7){
if (grepl(taxa_l[m],n1)){
name_new[m]=n1
}else{
name_new[m]=taxa_l[m]
}
}
name_new
taxa_l[m]
n1
m=7
grepl(taxa_l[m],n1)
name_new=vector()
for (m in 1:7){
if (any(grepl(taxa_l[m],n1))){
name_new[m]=n1
}else{
name_new[m]=taxa_l[m]
}
}
name_new
m
any(grepl(taxa_l[m],n1))
grep(taxa_l[m],n1)
name_new=vector()
for (m in 1:7){
if (any(grepl(taxa_l[m],n1))){
name_new[m]=n1[grep(taxa_l[m],n1)]
}else{
name_new[m]=taxa_l[m]
}
}
name_new
name_new1=paste(name_new,collapse = "--")
name_new1
rownames(tab_all)[miss_row[1]]
name_new1
rownames(tab_all)=gsub("--k__Fungi","",rownames(tab_all))
taxa_l=c("d__","p__","c__","o__","f__","g__","s__","t__")
miss_row=vector()
j=1
for (i in 1:nrow(tab_all)){
n1=strsplit(rownames(tab_all)[i],"--")[[1]]
n2=length(n1)
if(!grepl(taxa_l[n2],n1[n2])){
miss_row[j]=i
j=j+1
}
name_new=vector()
for (m in 1:7){
if (any(grepl(taxa_l[m],n1))){
name_new[m]=n1[grep(taxa_l[m],n1)]
}else{
name_new[m]=taxa_l[m]
}
}
name_new1=paste(name_new,collapse = "--")
}
rownames(tab_all)[miss_row[1:10]]
rownames(tab_all)=gsub("--k__Fungi","",rownames(tab_all))
taxa_l=c("d__","p__","c__","o__","f__","g__","s__","t__")
miss_row=vector()
j=1
name_new1=list()
for (i in 1:nrow(tab_all)){
n1=strsplit(rownames(tab_all)[i],"--")[[1]]
n2=length(n1)
for (m in 1:7){
if (any(grepl(taxa_l[m],n1))){
name_new[m]=n1[grep(taxa_l[m],n1)]
}else{
name_new[m]=taxa_l[m]
}
}
name_new1[j]=paste(name_new,collapse = "--")
if(!grepl(taxa_l[n2],n1[n2])){
miss_row[j]=i
j=j+1
}
}
name_new1[1]
rownames(tab_all)[i]
i
rownames(tab_all)[miss_row[1]]
name_new1[1]
rownames(tab_all)[miss_row[1:5]]
name_new1[1:5]
n1
m
sapply(strsplit(n1,"__"),"[[",1)
paste(sapply(strsplit(n1,"__"),"[[",1),"__")
paste0(sapply(strsplit(n1,"__"),"[[",1),"__")
match(paste0(sapply(strsplit(n1,"__"),"[[",1),"__"),taxa_l)
match1=match(paste0(sapply(strsplit(n1,"__"),"[[",1),"__"),taxa_l)
max(match1)
name_new=vector(length=max(match1))
name_new
name_new=vector()
name_new[match1]=n1
name_new
which(is.na(name_new))
taxa_l[which(is.na(name_new))]
name_new[which(is.na(name_new))]
name_new[which(is.na(name_new))]=taxa_l[which(is.na(name_new))]
name_new
name_new1[j]=paste(name_new,collapse = "--")
name_new1
name_new1=vector()
for (i in 1:nrow(tab_all)){
n1=strsplit(rownames(tab_all)[i],"--")[[1]]
n2=length(n1)
match1=match(paste0(sapply(strsplit(n1,"__"),"[[",1),"__"),taxa_l)
name_new=vector()
name_new[match1]=n1
name_new[which(is.na(name_new))]=taxa_l[which(is.na(name_new))]
name_new1[j]=paste(name_new,collapse = "--")
if(!grepl(taxa_l[n2],n1[n2])){
miss_row[j]=i
j=j+1
}
}
name_new1=vector()
for (i in 1:nrow(tab_all)){
n1=strsplit(rownames(tab_all)[i],"--")[[1]]
n2=length(n1)
if(!grepl(taxa_l[n2],n1[n2])){
miss_row[j]=i
match1=match(paste0(sapply(strsplit(n1,"__"),"[[",1),"__"),taxa_l)
name_new=vector()
name_new[match1]=n1
name_new[which(is.na(name_new))]=taxa_l[which(is.na(name_new))]
name_new1[j]=paste(name_new,collapse = "--")
j=j+1
}
}
name_new1
i
miss_row
miss_row[1:5]
i=26
n1=strsplit(rownames(tab_all)[i],"--")[[1]]
n2=length(n1)
!grepl(taxa_l[n2],n1[n2])
j
j=1
miss_row[j]=i
match1=match(paste0(sapply(strsplit(n1,"__"),"[[",1),"__"),taxa_l)
name_new=vector()
match1
name_new[match1]=n1
name_new
name_new[which(is.na(name_new))]=taxa_l[which(is.na(name_new))]
name_new
paste(name_new,collapse = "--")
miss_row=vector()
j=1
name_new1=vector()
for (i in 1:nrow(tab_all)){
n1=strsplit(rownames(tab_all)[i],"--")[[1]]
n2=length(n1)
if(!grepl(taxa_l[n2],n1[n2])){
miss_row[j]=i
match1=match(paste0(sapply(strsplit(n1,"__"),"[[",1),"__"),taxa_l)
name_new=vector()
name_new[match1]=n1
name_new[which(is.na(name_new))]=taxa_l[which(is.na(name_new))]
name_new1[j]=paste(name_new,collapse = "--")
j=j+1
}
}
name_new1
length(name_new1)
length(miss_row)
if(length(miss_row)!=0){
rownames(tab_all)[miss_row]=name_new1
}
rownames(tab_all)[26]
rownames(tab_all)[miss_row[1:10]]
format_wgs <- function(taxa_file = NULL,sep="\t",method="metaphlan",normalization=T,reads_cutoff=0,rarefy=F,rarefy_num=1000) {
tab_all=read.table(file=taxa_file,sep=sep,row.names=1,header = T,quote="",check.names=FALSE)
tab_all=as.matrix(tab_all[,order(colnames(tab_all))])
if(!is.null(reads_cutoff)){
tab_all=tab_all[,which(colSums(tab_all)>reads_cutoff)]
}
#tab_all=tab_all[grep("Bacteria",rownames(tab_all)),]
tab_all=tab_all[!rowSums(tab_all)==0,]
if (normalization){
if(rarefy){
tab_all <- rarefy(tab_all, rarefy_num)
}else{
tab_all=t(t(tab_all)/colSums(tab_all))*mean(colSums(tab_all))
}
}else{
tab_all=tab_all
}
tab_all=tab_all[order(rowSums(tab_all),decreasing = T),]
rownames(tab_all)=taxa_edit(rownames(tab_all))
tab_all=tab_all[which(!grepl("__--__--__",rownames(tab_all))),]
if (method=="kraken"){
rownames(tab_all)=gsub("--k__Fungi","",rownames(tab_all))
taxa_l=c("d__","p__","c__","o__","f__","g__","s__","t__")
miss_row=vector()
j=1
name_new1=vector()
for (i in 1:nrow(tab_all)){
n1=strsplit(rownames(tab_all)[i],"--")[[1]]
n2=length(n1)
if(!grepl(taxa_l[n2],n1[n2])){
miss_row[j]=i
match1=match(paste0(sapply(strsplit(n1,"__"),"[[",1),"__"),taxa_l)
name_new=vector()
name_new[match1]=n1
name_new[which(is.na(name_new))]=taxa_l[which(is.na(name_new))]
name_new1[j]=paste(name_new,collapse = "--")
j=j+1
}
}
if(length(miss_row)!=0){
rownames(tab_all)[miss_row]=name_new1
}
}else if (method=="metaphlan"){
tab_all=tab_all
}
return(tab_all)
}
runApp()
#Metaphlan2 and Kraken2 results
taxa_table9=format_wgs(taxa_file = "../data-raw/wgs_kraken2.txt")
grep("Fungi",rownames(taxa_table9))
rownames(taxa_table9)[grep("Fungi",rownames(taxa_table9))]
format_wgs <- function(taxa_file = NULL,sep="\t",method="metaphlan",normalization=T,reads_cutoff=0,rarefy=F,rarefy_num=1000) {
tab_all=read.table(file=taxa_file,sep=sep,row.names=1,header = T,quote="",check.names=FALSE)
tab_all=as.matrix(tab_all[,order(colnames(tab_all))])
if(!is.null(reads_cutoff)){
tab_all=tab_all[,which(colSums(tab_all)>reads_cutoff)]
}
tab_all=tab_all[!rowSums(tab_all)==0,]
if (normalization){
if(rarefy){
tab_all <- rarefy(tab_all, rarefy_num)
}else{
tab_all=t(t(tab_all)/colSums(tab_all))*mean(colSums(tab_all))
}
}else{
tab_all=tab_all
}
tab_all=tab_all[order(rowSums(tab_all),decreasing = T),]
rownames(tab_all)=taxa_edit(rownames(tab_all))
tab_all=tab_all[which(!grepl("__--__--__",rownames(tab_all))),]
if (method=="kraken"){
rownames(tab_all)=gsub("--k__Fungi","",rownames(tab_all))
taxa_l=c("d__","p__","c__","o__","f__","g__","s__","t__")
miss_row=vector()
j=1
name_new1=vector()
for (i in 1:nrow(tab_all)){
n1=strsplit(rownames(tab_all)[i],"--")[[1]]
n2=length(n1)
if(!grepl(taxa_l[n2],n1[n2])){
miss_row[j]=i
match1=match(paste0(sapply(strsplit(n1,"__"),"[[",1),"__"),taxa_l)
name_new=vector()
name_new[match1]=n1
name_new[which(is.na(name_new))]=taxa_l[which(is.na(name_new))]
name_new1[j]=paste(name_new,collapse = "--")
j=j+1
}
}
if(length(miss_row)!=0){
rownames(tab_all)[miss_row]=name_new1
}
}else if (method=="metaphlan"){
tab_all=tab_all
}
return(tab_all)
}
#Metaphlan2 and Kraken2 results
taxa_table9=format_wgs(taxa_file = "../data-raw/wgs_kraken2.txt")
rownames(taxa_table9)[grep("Fungi",rownames(taxa_table9))]
taxa_file = "../data-raw/wgs_kraken2.txt"
tab_all=read.table(file=taxa_file,sep=sep,row.names=1,header = T,quote="",check.names=FALSE)
tab_all=as.matrix(tab_all[,order(colnames(tab_all))])
if(!is.null(reads_cutoff)){
tab_all=tab_all[,which(colSums(tab_all)>reads_cutoff)]
}
tab_all=tab_all[!rowSums(tab_all)==0,]
if (normalization){
if(rarefy){
tab_all <- rarefy(tab_all, rarefy_num)
}else{
tab_all=t(t(tab_all)/colSums(tab_all))*mean(colSums(tab_all))
}
}else{
tab_all=tab_all
}
tab_all=tab_all[order(rowSums(tab_all),decreasing = T),]
rownames(tab_all)=taxa_edit(rownames(tab_all))
tab_all=tab_all[which(!grepl("__--__--__",rownames(tab_all))),]
rownames(tab_all)=gsub("--k__Fungi","",rownames(tab_all))
rownames(tab_all)[grep("Fungi",rownames(tab_all))]
#Metaphlan2 and Kraken2 results
taxa_table9=format_wgs(taxa_file = "../data-raw/wgs_kraken2.txt",method="kraken")
rownames(taxa_table9)[grep("Fungi",rownames(taxa_table9))]
runApp()
gc()
#Metaphlan2 and Kraken2 results
taxa_table9=format_wgs(taxa_file = "../data-raw/wgs_kraken2.txt",method="kraken",reads_cutoff=1000)
grep("Fungi",rownames(taxa_table9))
metadata_dir="./data-raw/metadata_mali.csv"
#TB data
taxa_table9=format_wgs(taxa_file = "../data-raw/wgs_kraken2.txt",method="kraken",reads_cutoff=1000)
#TB data
taxa_table9=format_wgs(taxa_file = "/Users/shansun/Google\ Drive/mali/TB_new/all_mali_kraken2.txt",method="kraken",reads_cutoff=1000)
metadata1=meta_format(metadata="/Users/shansun/Google\ Drive/mali/TB_new/metadata_mali_TB.csv",metadata_sep=",",meta_sample_name_col=1)
grep("Fungi",rownames(taxa_table9))
metadata1=meta_format(metadata="/Users/shansun/Google\ Drive/mali/TB_new/metadata_mali_TB.csv",metadata_sep=",",meta_sample_name_col=1)
head(metadata1)
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=10,taxa_level="phylum",xlab_direction=1,legend_size=1)
runApp('~/git/plotmicrobiome', display.mode = "showcase")
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",weight=8,height=6)
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
dev.off()
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=8,height=6)
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=8,height=6)
par(mfrow=c(1,1))
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=8,height=6)
par(mfrow=c(1,1).mar=c(5,3,3,3))
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=8,height=6)
par(mfrow=c(1,1),mar=c(5,3,3,3))
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=8,height=6)
par(mfrow=c(1,1),mar=c(5,3,3,3))
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=8,height=12)
par(mfrow=c(1,1),mar=c(5,3,3,3))
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=12,height=12)
par(mfrow=c(1,1),mar=c(5,3,3,3))
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=12,height=10)
par(mfrow=c(1,1),mar=c(5,3,3,3))
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=12,height=9)
par(mfrow=c(1,1),mar=c(5,3,3,3))
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=15,height=9)
par(mfrow=c(1,1),mar=c(5,3,3,3))
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=15,height=8)
par(mfrow=c(1,1),mar=c(5,3,3,3))
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=16,height=8)
par(mfrow=c(1,1),mar=c(5,3,3,3))
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=18,height=9)
par(mfrow=c(1,1),mar=c(5,3,3,3))
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=18,height=9)
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
pdf("/Users/shansun/Google\ Drive/mali/TB_new/phylum_bar.pdf",width=20,height=12)
taxa_barplot(taxa_table = taxa_table9, metadata=metadata1,test_metadata="group_time",num_taxa=8,taxa_level="phylum",xlab_direction=1,legend_size=1)
dev.off()
rm(list = ls())
.rs.restartR()
runApp()
